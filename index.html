<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dapatkan Lokasi dengan OpenStreetMap</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
      body {
        background: var(--bs-body-bg);
      }
      #map {
        height: 60vh; /* tinggi peta 60% layar */
        border-radius: 0.5rem;
        margin-top: 1rem;
      }
      @media (max-width: 600px) {
        #map {
          height: 50vh;
        }
      }
    </style>
  </head>
  <body>
    <div class="container py-4">
      <h2 class="text-center mb-4">Lokasi Saya</h2>

      <div class="card shadow-sm p-3">
        <div class="row g-3">
          <div class="col-12 col-md-6">
            <label for="latitude" class="form-label">Latitude</label>
            <input
              type="text"
              class="form-control"
              id="latitude"
              readonly
              onclick="copyToClipboard(this)"
            />
          </div>
          <div class="col-12 col-md-6">
            <label for="longitude" class="form-label">Longitude</label>
            <input
              type="text"
              class="form-control"
              id="longitude"
              readonly
              onclick="copyToClipboard(this)"
            />
          </div>
        </div>

        <div class="d-grid mt-3">
          <button class="btn btn-primary" onclick="getLocation()">
            üìç Gunakan Lokasi Saya
          </button>
        </div>
      </div>

      <div id="map" class="shadow-sm"></div>

      <!-- Toggle Dark/Light Mode -->
      <div class="d-flex justify-content-center mt-3">
        <div class="form-check form-switch">
          <input
            class="form-check-input"
            type="checkbox"
            role="switch"
            id="themeSwitch"
          />
          <label class="form-check-label" for="themeSwitch">üåô Dark Mode</label>
        </div>
      </div>

      <footer class="text-center mt-4 mb-2 text-body-secondary small">
        Created by <strong>Andre Cahya</strong>
      </footer>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
      // Inisialisasi Peta
      let map = L.map("map").setView([0, 0], 2);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(map);

      // Variabel global
      let marker = null;
      let accuracyCircle = null;

      // Fungsi untuk format angka tanpa trailing zero
      function formatHighPrecision(number, maxDecimals = 12) {
        // Konversi ke string dan hapus trailing zero
        let str = number.toString();

        // Jika ada titik desimal
        if (str.includes(".")) {
          // Hapus trailing zero
          str = str.replace(/\.?0+$/, "");

          // Jika perlu tambahkan digit hingga maxDecimals
          const decimalPart = str.split(".")[1] || "";
          if (decimalPart.length < maxDecimals) {
            // Tambahkan nol hanya jika diperlukan untuk presisi
            str = number.toFixed(maxDecimals).replace(/\.?0+$/, "");
          }
        }

        return str;
      }

      // Ambil lokasi
      function getLocation() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(showPosition, showError, {
            enableHighAccuracy: true,
            timeout: 30000,
            maximumAge: 0,
          });
        } else {
          alert("Geolocation tidak didukung browser ini.");
        }
      }

      function showPosition(position) {
        const accuracy = position.coords.accuracy;
        console.log("Data GPS lengkap:", position.coords);

        if (accuracy > 100) {
          // Jika akurasi buruk (>100 meter)
          alert(
            "‚ö†Ô∏è Akurasi GPS buruk!\n\nSilakan:\n‚Ä¢ Aktifkan GPS\n‚Ä¢ Buka di area terbuka\n‚Ä¢ Refresh halaman dan coba lagi"
          );
        }

        // Format koordinat
        const lat = formatHighPrecision(position.coords.latitude);
        const lon = formatHighPrecision(position.coords.longitude);

        document.getElementById("latitude").value = lat;
        document.getElementById("longitude").value = lon;

        // Hanya zoom jika akurasi baik
        if (accuracy <= 100) {
          map.setView(
            [position.coords.latitude, position.coords.longitude],
            17
          );
        } else {
          map.setView(
            [position.coords.latitude, position.coords.longitude],
            10
          );
        }

        // Remove existing marker
        if (marker) {
          map.removeLayer(marker);
        }

        // Add new marker dengan informasi akurasi
        marker = L.marker([position.coords.latitude, position.coords.longitude])
          .addTo(map)
          .bindPopup(
            `
            <b>Lokasi Anda</b><br>
            Lat: ${lat}<br>
            Lon: ${lon}<br>
            Akurasi: ¬±${accuracy.toFixed(2)} meter
        `
          )
          .openPopup();

        // Tambahkan circle untuk menunjukkan area akurasi
        if (accuracyCircle) {
          map.removeLayer(accuracyCircle);
        }

        accuracyCircle = L.circle(
          [position.coords.latitude, position.coords.longitude],
          {
            radius: accuracy,
            color: "blue",
            fillColor: "#3388ff",
            fillOpacity: 0.2,
          }
        ).addTo(map);
      }

      function showError(error) {
        let errorMessage = "Error mendapatkan lokasi: ";

        switch (error.code) {
          case error.PERMISSION_DENIED:
            errorMessage += "Izin geolokasi ditolak";
            break;
          case error.POSITION_UNAVAILABLE:
            errorMessage += "Informasi lokasi tidak tersedia";
            break;
          case error.TIMEOUT:
            errorMessage += "Waktu permintaan lokasi habis";
            break;
          case error.UNKNOWN_ERROR:
            errorMessage += "Error tidak diketahui";
            break;
        }

        console.error(errorMessage);
        alert(errorMessage);
      }

      // Copy koordinat ke clipboard
      function copyToClipboard(el) {
        el.select();
        document.execCommand("copy");

        const toast = document.createElement("div");
        toast.className =
          "toast align-items-center text-white bg-success border-0 position-fixed bottom-0 end-0 m-3";
        toast.innerHTML = `<div class="d-flex"><div class="toast-body">üìã Disalin: ${el.value}</div></div>`;
        document.body.appendChild(toast);
        new bootstrap.Toast(toast, { delay: 2000 }).show();
        setTimeout(() => toast.remove(), 2500);
      }

      // Dark/Light mode toggle
      const themeSwitch = document.getElementById("themeSwitch");
      const htmlEl = document.documentElement;

      // cek mode tersimpan
      if (localStorage.getItem("theme")) {
        htmlEl.setAttribute("data-bs-theme", localStorage.getItem("theme"));
        themeSwitch.checked = localStorage.getItem("theme") === "dark";
      }

      themeSwitch.addEventListener("change", () => {
        if (themeSwitch.checked) {
          htmlEl.setAttribute("data-bs-theme", "dark");
          localStorage.setItem("theme", "dark");
        } else {
          htmlEl.setAttribute("data-bs-theme", "light");
          localStorage.setItem("theme", "light");
        }
      });
    </script>
  </body>
</html>
